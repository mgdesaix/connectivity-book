# Migratory Network Model {#connectivity}

## Input data

The input data we need for the migratory network model are:

* Relative abundance matrix for each node
* Assignment matrix of individuals among nodes

We demonstrate in the previous [relative abundance section](#abundance) how to obtain the relative abundance data needed for the model. The relative abundance data need to be in the following format, with population IDs (same names as in the *assignment* file) in the first column and relative abundance values in the second column. Column names can follow any naming convention when inputting these data into `mignette`.

```{r, echo=FALSE}
knitr::kable(mignette::amre_abundance)
```

For the assignment matrix, the input data needs to correspond to the following format:

```{r, echo=FALSE}
knitr::kable(mignette::amre_assign)
```

where the first column specifies breeding population IDs while subsequent columns are the nonbreeding populations. The values are the number of individuals that connect each node. Depending on the type of assignment data the `mignette` user has, individual data points may need to be associated with a specific population. For these types of basic spatial analyses, `mignette` users can check out the `sf` package, specifically the `st_intersection()` function, or whatever geospatial tools they prefer to create these data. Once you have connectivity data in the above format, you can continue with the following sections.

For the following functions, we specify the order of the populations we are using for the model. Here, we are just ordering populations geographically by longitude to facilitate straightforward interpretation of the output.

```{r}
bnode_names <- c("WB", "BR", "NT", "ST", "MP")
wnode_names <- c("ALM", "LCA", "HCA", "CAR", "AONU")
```

## Migratory network model (JAGS)

### Preparing input data

The following code provides the necessary data to run the JAGS model. To create the migratory network, the user first creates a text file specifying the JAGS model to be used, providing the name of the file to be saved (`base_filename`) and the type of model type (`model_type`). Currently `mignette` supports two model types based on the type of data used to determine assignment of individuals: `1` indicates that only genetic data were used for assignment, and `2` indicates that there's assignment data from both genetic and geolocator data. Here, the example only uses genetic data. `get_jags_model()` saves a `.txt` file with the `base_filename` and stores that name as a variable for use in JAGS. We also specify the desired order of the breeding populations (`bnode_names`) and the nonbreeding populations (`wnode_names`). Finally, we use these as input into the function `get_jags_data()` to prepare the data appropriately for the model.

```r
base_filename <- mignette::get_jags_model(base_filename = "amre.genetic.model", model_type = 1)
jags_data <- mignette::get_jags_data(abundance = mignette::amre_abundance, 
                           assignment = mignette::amre_assign,
                           bnode_names = bnode_names, 
                           wnode_names = wnode_names)
```


### Running the model

Now the user can use the output of `jags_data` into JAGS to run the actual model:

```r
parameters <- c("conn_g")
ni <- 500000
nt <- 4
nb <- 100000
nc <- 2
jags_out <- autojags(jags_data, inits=NULL, parameters, paste0(base_filename,".txt"),
                      n.chains = nc, n.thin =nt, iter.increment=ni,
                      max.iter = ni*50+nb, n.burnin = nb,
                      n.adapt= NULL, parallel=TRUE)
amre_conn <- jags_out$mean$conn_g
colnames(amre_conn) <- wnode_names
rownames(amre_conn) <- bnode_names
amre_conn
```

```{r, echo=FALSE}
amre_conn <- mignette::amre_conn
knitr::kable(mignette::amre_conn)
```

The connectivity between the nodes is provided by the `conn_g` parameter of the model, which is accessed from the above code. The rows are the breeding nodes (the *inferred* population from assignment) and the columns are the nonbreeding nodes (the *sampled* population).

Voila. A migratory network model is completed. Now, onto [visualization](#visualization)

