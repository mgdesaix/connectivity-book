<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Breeding nodes | Creating Migratory Connectivity Networks in R</title>
  <meta name="description" content="This provides examples and documentation of the MuSpTest package" />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Breeding nodes | Creating Migratory Connectivity Networks in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This provides examples and documentation of the MuSpTest package" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Breeding nodes | Creating Migratory Connectivity Networks in R" />
  
  <meta name="twitter:description" content="This provides examples and documentation of the MuSpTest package" />
  

<meta name="author" content="Matt DeSaix" />


<meta name="date" content="2021-11-29" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="wintering.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Migratory Connectivity Networks in R</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#installation"><i class="fa fa-check"></i><b>1.1</b> Installation</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="breeding.html"><a href="breeding.html"><i class="fa fa-check"></i><b>2</b> Breeding nodes</a>
<ul>
<li class="chapter" data-level="2.1" data-path="breeding.html"><a href="breeding.html#ebirdst"><i class="fa fa-check"></i><b>2.1</b> ebirdst</a></li>
<li class="chapter" data-level="2.2" data-path="breeding.html"><a href="breeding.html#seasonal-abundance"><i class="fa fa-check"></i><b>2.2</b> Seasonal abundance</a></li>
<li class="chapter" data-level="2.3" data-path="breeding.html"><a href="breeding.html#generating-seasonal-polygons"><i class="fa fa-check"></i><b>2.3</b> Generating seasonal polygons</a></li>
<li class="chapter" data-level="2.4" data-path="breeding.html"><a href="breeding.html#creating-the-genoscape"><i class="fa fa-check"></i><b>2.4</b> Creating the genoscape</a></li>
<li class="chapter" data-level="2.5" data-path="breeding.html"><a href="breeding.html#genoscape-polygons"><i class="fa fa-check"></i><b>2.5</b> Genoscape polygons</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="wintering.html"><a href="wintering.html"><i class="fa fa-check"></i><b>3</b> Wintering nodes</a>
<ul>
<li class="chapter" data-level="3.1" data-path="wintering.html"><a href="wintering.html#subsetting-winter-ecoregions"><i class="fa fa-check"></i><b>3.1</b> Subsetting winter ecoregions</a></li>
<li class="chapter" data-level="3.2" data-path="wintering.html"><a href="wintering.html#snap-points"><i class="fa fa-check"></i><b>3.2</b> Snap points</a></li>
<li class="chapter" data-level="3.3" data-path="wintering.html"><a href="wintering.html#finalize-wintering-nodes"><i class="fa fa-check"></i><b>3.3</b> Finalize wintering nodes</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="connectivity.html"><a href="connectivity.html"><i class="fa fa-check"></i><b>4</b> Connectivity Model</a>
<ul>
<li class="chapter" data-level="4.1" data-path="connectivity.html"><a href="connectivity.html#specifying-relative-abundance"><i class="fa fa-check"></i><b>4.1</b> Specifying relative abundance</a></li>
<li class="chapter" data-level="4.2" data-path="connectivity.html"><a href="connectivity.html#run-connectivity-model"><i class="fa fa-check"></i><b>4.2</b> Run connectivity model</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="network-visualization.html"><a href="network-visualization.html"><i class="fa fa-check"></i><b>5</b> Network visualization</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Creating Migratory Connectivity Networks in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="breeding" class="section level1" number="2">
<h1><span class="header-section-number">Chapter 2</span> Breeding nodes</h1>
<p>Breeding nodes are delineated by the genetically distinct populations on the breeding grounds. In this example, we’ll show how to use <a href="https://ebird.org/science/status-and-trends">eBird Status and Trends</a> data to specify the breeding range and then use genetic data from admixture analyses to specify the spatial extent of the breeding nodes.</p>
<div id="ebirdst" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> ebirdst</h2>
<p>In the migratory network analyses, the <code>ebirdst</code> abundance data is used to delineate the different stages of the annual cycle. The <code>MuSpTest</code> package provides code for these first sections that function as a wrapper for the <code>ebirdst</code> package to streamline the process. If you would like to know more about the underlying <code>ebirdst</code> code and analyses, check out the <a href="https://cornelllabofornithology.github.io/ebirdst/articles/ebirdst-advanced-mapping.html">excellent tutorial</a> by Strimas-Mackey, Auer, and Fink.</p>
<p>Prior to doing anything with eBird Status and Trends data, you will need to download the <code>ebirdst</code> package, and then get access to the data. To download the package:</p>
<pre><code># install.packages(&quot;remotes&quot;)
remotes::install_github(&quot;CornellLabofOrnithology/ebirdst&quot;)</code></pre>
<p>Then, get access to <code>ebirdst</code> data at <a href="https://ebird.org/st/request" class="uri">https://ebird.org/st/request</a>. You will receive a key to download <code>ebirdst</code> data and you can enter that key in R:</p>
<pre><code>ebirdst::set_ebirdst_access_key(&quot;XXXXX&quot;)</code></pre>
<p>where <code>"XXXXX"</code> is the key.</p>
<p>The primary packages for this vignette are:</p>
<pre><code>library(MuSpTest)
library(sf)
library(terra)
library(tidyverse)
library(ebirdst)
library(rnaturalearth)</code></pre>
</div>
<div id="seasonal-abundance" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Seasonal abundance</h2>
<p>The first function, <code>get_ebirdst_abd_season()</code>, downloads species data and creates a multi-layered raster of seasonal abundance data (nonbreeding, prebreeding migration, breeding, and postbreeding migration). The function currently takes two inputs, <code>species</code> and <code>path</code>. <code>ebirdst</code> data download is based on the six-letter species code, thus, we use the same naming system. You can find the specific codes with the <a href="https://rdrr.io/github/CornellLabofOrnithology/ebirdst/man/get_species.html">get_species</a> function from the <code>ebirdst</code> package.</p>
<p>Specify the species of interest for <code>get_ebirdst_abd_season()</code> with <code>species</code>. <code>path</code> specifies the output path for the single multi-layered raster file that is produced, with the default being the current directory. If you want to output to another directory, make sure that directory is already created. The output naming convention for the raster is “[species code].abd_season.tif.”</p>
<p>Below is an example for downloading data for the <a href="https://ebird.org/species/comyel">Common Yellowthroat</a> and creating the seasonal abundance raster stack.</p>
<pre><code># This can take a while depending on the species (5-10 min.)
abd_season &lt;- get_ebirdst_abd_season(species = &quot;comyel&quot;, path = &quot;./comyel/&quot;)</code></pre>
</div>
<div id="generating-seasonal-polygons" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Generating seasonal polygons</h2>
<p>Using the previously created seasonal abundance rasters, we will convert them to polygons of the range. The details can be found in the <code>ebirdst</code> <a href="https://cornelllabofornithology.github.io/ebirdst/articles/ebirdst-advanced-mapping.html">tutorial</a>, but the gist of it is that we’ll distinguish non-zero abundance from non-predicted areas, and delineate nice <em>smooth</em> ranges for the different stages.</p>
<p>We also need land extent data. We will get land data from the <code>rnaturalearth</code> package using the following code. Depending on the organism’s range, you will need to filter continent to the appropriate region. Here, we want both North and South America.</p>
<pre><code>ne_scale &lt;- 50
# land polygon
ne_land &lt;- rnaturalearth::ne_countries(scale = ne_scale, returnclass = &quot;sf&quot;) %&gt;%
  dplyr::filter(continent %in% c(&quot;North America&quot;, &quot;South America&quot;)) %&gt;%
  sf::st_set_precision(1e6) %&gt;%
  sf::st_union() %&gt;% 
  sf::st_geometry()
ne_land_proj &lt;- sf::st_transform(ne_land, crs = sf::st_crs(abd_season))</code></pre>
<p>Now we have all the input data we need to get the polygons of the range. The function <code>range_smooth()</code> in the <code>MuSpTest</code> package takes care of this. In the process of smoothing the polygon, small regions are dropped and holes in the polygon filled in based on the size (<span class="math inline">\(km^2\)</span>) specified with the <code>smooth_area</code> parameter. Below it is set at 1000 <span class="math inline">\(km^2\)</span> (e.g. a 31.6 km * 31.6 km square), but you may want to increase or decrease depending on the organism.</p>
<pre><code># this fuction can take a while (~10 min.)
comyel_range_smooth &lt;- range_smooth(abd_season = abd_season, 
                                  path = &quot;./comyel/shapefiles&quot;, 
                                  filename = &quot;range_smooth&quot;,
                                  ne_land = ne_land_proj,
                                  smooth_area = 1000,
                                  split_migration = FALSE, 
                                  show_yearround = FALSE)</code></pre>
<p>Extracting a single polygon of a portion of the range is simple and quick! Here’s an example of getting the <em>breeding</em> season range from the <code>range_smooth()</code> output.</p>
<pre><code>comyel_breed_smooth &lt;- dplyr::filter(comyel_range_smooth,
                                season == &quot;breeding&quot;) %&gt;%
                    sf::st_transform(crs = 4326)

sf::st_write(comyel_breed_smooth, dsn = &#39;./comyel/shapefiles&#39;,
          layer = &quot;comyel_breed_smooth&quot;,
          driver = &quot;ESRI Shapefile&quot;)</code></pre>
</div>
<div id="creating-the-genoscape" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> Creating the genoscape</h2>
<p>This is modified from Eric Anderson’s <a href="https://github.com/eriqande/make-a-BGP-map">Github project</a> that uses a matrix of individual Q-values to create a rasters of genetically distinct clusters - the <strong>genoscape</strong>. If you want to learn the ins and outs of making a <em>beautiful</em> genoscape map, check out Eric’s awesome <a href="https://github.com/eriqande/make-a-BGP-map">tutorial</a>. We will use the breeding polygon created in the previous step to specify the breeding range for the genoscape. The input data we need are:</p>
<ul>
<li>Individual Q-value matrix</li>
<li>Lat/lon matrix of individual</li>
<li>Breeding range polygon</li>
</ul>
<p>The <code>comyel_assignment</code> data set provides admixture results (Q-values) of five genotype clusters for Common Yellowthroat (cite a coye paper) and metadata for the sampled individuals.</p>
<pre><code>Q_matrix &lt;- MuSpTest::comyel_assignment %&gt;%
  dplyr::select(CA, Midwest, NewEngland, West, Southwest) %&gt;%
  as.matrix()
long_lat_matrix &lt;- MuSpTest::comyel_assignment %&gt;%
  dplyr::select(Long, Lat) %&gt;%
  as.matrix()
cluster_colors &lt;-  c(
  CA = &quot;#CC0000&quot;,
  Midwest = &quot;#3399FF&quot;,
  NewEngland = &quot;#9933CC&quot;,
  West = &quot;#009933&quot;,
  Southwest = &quot;#FF6600&quot;) </code></pre>
<p>We will use a <a href="https://github.com/eriqande/TESS3_encho_sen">modified version</a> of the <code>tess3r</code> package to create the genoscape rasters.</p>
<pre><code># remotes::install_github(&quot;eriqande/TESS3_encho_sen&quot;)
genoscape_brick &lt;- tess3r::tess3Q_map_rasters(
  x = Q_matrix, 
  coord = long_lat_matrix,  
  map.polygon = breed_smooth,
  window = terra::ext(breed_smooth)[1:4],
  resolution = c(300,300), # if you want more cells in your raster, set higher
  col.palette = tess3r::CreatePalette(cluster_colors, length(cluster_colors)), 
  method = &quot;map.max&quot;, 
  interpol = tess3r::FieldsKrigModel(10),  
  main = &quot;Ancestry coefficients&quot;,
  xlab = &quot;Longitude&quot;, 
  ylab = &quot;Latitude&quot;, 
  cex = .4
)
names(genoscape_brick) &lt;- colnames(Q_matrix)

out.files &lt;- paste0(&quot;./comyel/genoscape/comyel_genoscape_cluster_&quot;, names(genoscape_brick), &quot;.tif&quot;)
terra::writeRaster(terra::rast(genoscape_brick), filename = out.files)</code></pre>
</div>
<div id="genoscape-polygons" class="section level2" number="2.5">
<h2><span class="header-section-number">2.5</span> Genoscape polygons</h2>
<p>Using the genoscape rasters we will convert them to polygons, using the handy <code>scape_to_shape()</code> function. The <code>prob_threshold</code> parameter specifies the value to determine if a raster cell is included in the polygon for that genoscape. This value should be customized for different species to check for overlap of genoscape polygons, which is not desirable. Setting too high of a threshold will create very small breeding nodes, while too low of a threshold will result in large, overlapping breeding nodes.</p>
<pre><code>genoscape_files &lt;- list.files(&quot;./comyel/genoscape&quot;, 
                                     full.names = T,
                                     pattern = &quot;*.tif&quot;)

genoscape_raster_stack &lt;- terra::rast(genoscape_files)
genoscape_polygon_sf &lt;- scape_to_shape(x = genoscape_raster_stack, prob_threshold = 0.5)</code></pre>
<p>Check out the polygons</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="breeding.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb12-2"><a href="breeding.html#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> genoscape_polygon_sf,<span class="at">alpha =</span> <span class="fl">0.75</span>, <span class="fu">aes</span>(<span class="at">fill =</span> Cluster)) <span class="sc">+</span></span>
<span id="cb12-3"><a href="breeding.html#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> cluster_colors)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>Check which polygons are overlapping. Each row of the output provides a pair of overlapping polygons (if there are any).</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="breeding.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">check_genoscape_overlap</span>(genoscape_polygon_sf)</span></code></pre></div>
<pre><code>##      [,1]      [,2]        
## [1,] &quot;CA&quot;      &quot;West&quot;      
## [2,] &quot;Midwest&quot; &quot;NewEngland&quot;
## [3,] &quot;Midwest&quot; &quot;West&quot;</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="wintering.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/01-breedingnodes.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
